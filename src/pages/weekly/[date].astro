---
import Base from "../../layouts/Base.astro";
import ActionBar from "../../components/ActionBar.astro";
import { getWeeklyDigest, getAllWeeklyDates } from "../../lib/digest";
import { COUNTRY_FLAGS, formatDate, formatDateShort } from "../../lib/constants";
import { md, stripMd } from "../../lib/md";

export function getStaticPaths() {
  const dates = getAllWeeklyDates();
  return dates.map((date) => ({ params: { date } }));
}

const { date } = Astro.params;
const page = getWeeklyDigest(date!);
const allWeekly = getAllWeeklyDates();

if (!page) {
  return Astro.redirect("/404");
}

const idx = allWeekly.indexOf(date!);
const prevWeek = idx < allWeekly.length - 1 ? allWeekly[idx + 1] : null;
const nextWeek = idx > 0 ? allWeekly[idx - 1] : null;

const title = `Week of ${formatDateShort(page.digest.week_start)} — ${formatDateShort(page.digest.week_end)} | What Is The Govt Saying`;
const description = page.digest.global_summary.replace(/[*_#>\[\]|]/g, "").slice(0, 160);
const globalHtml = md(page.digest.global_summary);
---

<Base title={title} description={description} date={page.digest.week_end} ogImage={`/og/weekly/${date}.png`} type="article">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 py-4 sm:py-6">
    <nav class="flex items-center justify-center gap-2 sm:gap-4 py-3 sm:py-4" aria-label="Weekly navigation">
      {prevWeek ? (
        <a href={`/weekly/${prevWeek}/`} class="text-xs sm:text-sm text-(--color-accent) no-underline hover:underline">
          &larr; Prev
        </a>
      ) : (
        <span class="text-xs sm:text-sm text-(--color-ink-muted)">&larr;</span>
      )}

      <span class="font-headline text-base sm:text-lg font-bold text-(--color-ink) text-center">
        {formatDateShort(page.digest.week_start)} — {formatDate(page.digest.week_end)}
      </span>

      {nextWeek ? (
        <a href={`/weekly/${nextWeek}/`} class="text-xs sm:text-sm text-(--color-accent) no-underline hover:underline">
          Next &rarr;
        </a>
      ) : (
        <span class="text-xs sm:text-sm text-(--color-ink-muted)">&rarr;</span>
      )}
    </nav>

    <div class="flex items-center justify-center gap-1 mb-4 sm:mb-6">
      <nav class="flex gap-1" aria-label="View mode">
        <a href="/" class="px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-semibold bg-(--color-surface-alt) text-(--color-ink-muted) hover:text-(--color-ink) no-underline rounded-l border border-(--color-rule)">
          Daily
        </a>
        <span class="px-3 sm:px-4 py-1.5 text-xs sm:text-sm font-semibold bg-(--color-ink) text-(--color-surface) rounded-r">
          Weekly
        </span>
      </nav>
    </div>

    <section class="mt-4 sm:mt-6 mb-8 sm:mb-10">
      <div class="flex items-start justify-between gap-3 border-t-3 border-(--color-ink) pt-4 mb-4">
        <h2 class="font-headline text-xl sm:text-2xl md:text-3xl font-bold text-(--color-ink)">
          {stripMd(page.digest.global_title)}
        </h2>
        <ActionBar title={title} description={description} />
      </div>
      <div class="prose text-(--color-ink-light) leading-relaxed text-base sm:text-lg" set:html={globalHtml} />
    </section>

    <div class="space-y-6 sm:space-y-8">
      {page.countries.map((country) => {
        const flag = COUNTRY_FLAGS[country.country_code] || "";
        return (
          <section class="border-t border-(--color-rule) pt-4 sm:pt-6">
            <div class="flex items-baseline gap-2 mb-1">
              <span class="text-base sm:text-lg" aria-hidden="true">{flag}</span>
              <span class="text-xs font-semibold uppercase tracking-wide text-(--color-ink-muted)">
                {country.country_name}
              </span>
            </div>
            {country.title && (
              <h3 class="font-headline text-lg sm:text-xl font-bold text-(--color-ink) mb-2">
                {stripMd(country.title)}
              </h3>
            )}
            <div class="prose text-(--color-ink-light) leading-relaxed text-sm sm:text-base" set:html={md(country.summary)} />
          </section>
        );
      })}
    </div>
  </div>
</Base>
